#include <iostream>
#include <cmath>
using namespace std;

void solveSystem(int n, double* a, double* b, double* c, double* r, double* t) {
    if (n < 4) {
        cout << "Ошибка: n должно быть >= 4" << endl;
        return;
    }

    double* alpha = new double[n];  
    double* beta = new double[n];  

    for (int i = 0; i < n; i++) {
        alpha[i] = beta[i] = t[i] = 0.0;
    }

    // Прямой ход прогонки
    alpha[2] = -c[1] / b[1];
    beta[2] = r[1] / b[1];

    for (int i = 2; i <= n - 3; i++) {
        double denom = a[i] * alpha[i] + b[i];
        alpha[i + 1] = -c[i] / denom;
        beta[i + 1] = (r[i] - a[i] * beta[i]) / denom;
    }

    // Обратный ход прогонки
    t[n - 2] = (r[n - 2] - a[n - 2] * beta[n - 2]) / (a[n - 2] * alpha[n - 2] + b[n - 2]);
    t[n - 1] = 0.0;  // Естественное граничное условие

    for (int i = n - 3; i >= 1; i--) {
        t[i] = alpha[i + 1] * t[i + 1] + beta[i + 1];
    }

    delete[] alpha;
    delete[] beta;
}

int main() {
    setlocale(LC_ALL, "RU");

    int n;
    cout << "Введите количество узлов n: ";
    cin >> n;

    if (n < 3) {
        cout << "Ошибка: количество узлов должно быть не менее 3" << endl;
        return 1;
    }

    // Динамическое выделение памяти
    double* x = new double[n];
    double* y = new double[n];
    double* h = new double[n - 1];

    // Ввод данных
    cout << "Введите координаты x узлов:" << endl;
    for (int i = 0; i < n; i++) {
        cout << "x[" << i + 1 << "] = ";
        cin >> x[i];
    }

    cout << "Введите значения функции y в узлах:" << endl;
    for (int i = 0; i < n; i++) {
        cout << "y[" << i + 1 << "] = ";
        cin >> y[i];
    }

    double x0;
    cout << "Введите значение аргумента x0: ";
    cin >> x0;

    // 1. Вычисление шагов h_i
    for (int i = 0; i < n - 1; i++) {
        h[i] = x[i + 1] - x[i];
    }

    // 2. Формирование трехдиагональной системы для моментов M
    int m = n - 2;  // Количество уравнений
    double* a = new double[n];
    double* b = new double[n];
    double* c = new double[n];
    double* r = new double[n];
    double* M = new double[n];

    // Инициализация нулями
    for (int i = 0; i < n; i++) {
        a[i] = b[i] = c[i] = r[i] = M[i] = 0.0;
    }

    // Заполнение матрицы системы и правой части
    for (int j = 1; j <= m; j++) {
        // Заполнение диагоналей матрицы
        if (j == 1) {
            b[j] = 2.0 * (h[0] + h[1]);
            c[j] = h[1];
        }
        else if (j == m) {
            a[j] = h[j - 1];
            b[j] = 2.0 * (h[j - 1] + h[j]);
        }
        else {
            a[j] = h[j - 1];
            b[j] = 2.0 * (h[j - 1] + h[j]);
            c[j] = h[j];
        }

        // Формирование правой части
        if (j == 1) {
            r[j] = 3.0 * ((y[2] - y[1]) / h[1] - (y[1] - y[0]) / h[0]);
        }
        else if (j == m) {
            r[j] = 3.0 * ((y[n - 1] - y[n - 2]) / h[n - 2] - (y[n - 2] - y[n - 3]) / h[n - 3]);
        }
        else {
            r[j] = 3.0 * ((y[j + 1] - y[j]) / h[j] - (y[j] - y[j - 1]) / h[j - 1]);
        }
    }

    // 3. Решение системы для моментов M
    solveSystem(n, a, b, c, r, M);

    // Установка естественных граничных условий
    M[0] = 0.0;
    M[n - 1] = 0.0;

    // 4. Определение интервала, содержащего x0
    int interval = -1;
    for (int i = 0; i < n - 1; i++) {
        if (x0 >= x[i] && x0 <= x[i + 1]) {
            interval = i;
            break;
        }
    }

    if (interval == -1) {
        cout << "Ошибка: x0 находится вне диапазона" << endl;

        delete[] x; delete[] y; delete[] h;
        delete[] a; delete[] b; delete[] c; delete[] r; delete[] M;
        return 1;
    }

    // 5. Вычисление значения сплайна в точке x0
    double dx = x0 - x[interval];
    double dx2 = dx * dx;
    double dx3 = dx2 * dx;

    // Формула кубического сплайна
    double S = y[interval] +
        ((y[interval + 1] - y[interval]) / h[interval] -
            h[interval] * (2.0 * M[interval] + M[interval + 1]) / 6.0) * dx +
        (M[interval] / 2.0) * dx2 +
        ((M[interval + 1] - M[interval]) / (6.0 * h[interval])) * dx3;

    cout << "\nРезультаты:" << endl;
    cout << "Значение сплайна в точке x0 = " << x0 << ": " << S << endl;

    cout << "\nМоменты (вторые производные) в узлах:" << endl;
    for (int i = 0; i < n; i++) {
        cout << "M[" << i + 1 << "] = " << M[i] << endl;
    }

    delete[] x; delete[] y; delete[] h;
    delete[] a; delete[] b; delete[] c; delete[] r; delete[] M;

    return 0;
}
